from maraboupy.MarabouRNNMultiDim import prove_multidim_property

from rnn_algorithms.RandomAlphasSGD import RandomAlphasSGD
from rnn_algorithms.MaxAlphasSGDInfStart import MaxAlphasSGD
from rnn_algorithms.IterateAlphasSGD import IterateAlphasSGD
from maraboupy.keras_to_marabou_rnn import RnnMarabouModel, calc_min_max_by_radius, negate_equation
from maraboupy import MarabouCore
from timeit import default_timer as timer
import numpy as np

MODELS_FOLDER = "/home/yuval/projects/Marabou/models/"


def adversarial_query(x: list, radius: float, y_idx_max: int, other_idx: int, h5_file_path: str, algorithm_ptr,
                      n_iterations=10):
    '''
    Query marabou with adversarial query
    :param x: base_vector (input vector that we want to find a ball around it)
    :param radius: determines the limit of the inputs around the base_vector
    :param y_idx_max: max index in the output layer
    :param other_idx: which index to compare max idx
    :param h5_file_path: path to keras model which we will check on
    :param algorithm_ptr: TODO
    :param n_iterations: number of iterations to run
    :return: True / False
    '''

    # assert_adversarial_query(x, y_idx_max, other_idx, h5_file_path, n_iterations, is_fail_test)
    rnn_model = RnnMarabouModel(h5_file_path, n_iterations)
    xlim = calc_min_max_by_radius(x, radius)
    rnn_model.set_input_bounds(xlim)
    initial_values = rnn_model.get_rnn_min_max_value_one_iteration(xlim)

    # output[y_idx_max] >= output[0] <-> output[y_idx_max] - output[0] >= 0, before feeding marabou we negate this
    adv_eq = MarabouCore.Equation(MarabouCore.Equation.GE)
    adv_eq.addAddend(-1, rnn_model.output_idx[other_idx])
    adv_eq.addAddend(1, rnn_model.output_idx[y_idx_max])
    adv_eq.setScalar(0)

    rnn_output_idxs = rnn_model.rnn_out_idx
    rnn_start_idxs = [i - 3 for i in rnn_output_idxs]

    # Convert the initial values to the SGDAlphaAlgorithm format
    rnn_max_values = [val[1] for val in initial_values]
    rnn_min_values = [val[0] for val in initial_values]

    assert sum([rnn_max_values[i] >= rnn_min_values[i] for i in range(len(rnn_max_values))]) == len(rnn_max_values)

    algorithm = algorithm_ptr((rnn_min_values, rnn_max_values), rnn_start_idxs, rnn_output_idxs)
    # rnn_model.network.dump()
    return prove_multidim_property(rnn_model.network, rnn_start_idxs, rnn_output_idxs, [negate_equation(adv_eq)],
                                   algorithm)


def classes20_1rnn2_1fc2():
    n_inputs = 40
    y_idx_max = 19
    other_idx = 10
    n_iterations = 10
    # (rnn_min_values, rnn_max_values), rnn_start_idxs, rnn_output_idxs
    algorithm = RandomAlphasSGD

    from timeit import default_timer as timer
    start = timer()
    assert adversarial_query([79] * n_inputs, 0, y_idx_max, other_idx,
                             "/home/yuval/projects/Marabou/model_classes20_1rnn2_1_2_4.h5", algorithm, n_iterations)
    rand_time = timer() - start

    algorithm = IterateAlphasSGD
    from timeit import default_timer as timer
    start = timer()
    assert adversarial_query([79] * n_inputs, 0, y_idx_max, other_idx,
                             "/home/yuval/projects/Marabou/model_classes20_1rnn2_1_2_4.h5", algorithm, n_iterations)
    iter_time = timer() - start
    return iter_time, rand_time


def run_one_comparison(in_tensor, radius, idx_max, other_idx, h5_file, n_iterations):
    results = {}
    # algorithms = [MaxAlphasSGD, IterateAlphasSGD, RandomAlphasSGD]
    algorithms = [IterateAlphasSGD]
    for algo in algorithms:
        start = timer()
        res = adversarial_query(in_tensor, radius, idx_max, other_idx, h5_file, algo, n_iterations)
        end = timer()
        results[algo.__name__] = {'time': end - start, 'result': res}
        print("%%%%%%%%% {} %%%%%%%%%".format(end - start))
    return results


experiemnts = [
    {'idx_max': 9, 'other_idx': 14, 'in_tensor': np.array([0.43679032, 0.51105192, 0.01603254, 0.45879329, 0.64639347,
                                                           0.39209051, 0.98618169, 0.49293316, 0.70440262, 0.08594672,
                                                           0.17252591, 0.4940284, 0.83947774, 0.55545332, 0.8971317,
                                                           0.72996308, 0.23706766, 0.66869303, 0.74949942, 0.57524252,
                                                           0.94886307, 0.31034989, 0.41785656, 0.5697128, 0.74751913,
                                                           0.48868271, 0.22672374, 0.6350584, 0.88979192, 0.97493685,
                                                           0.96969836, 0.99457045, 0.89433312, 0.19916606, 0.63957592,
                                                           0.02826659, 0.08104817, 0.20176526, 0.1114994, 0.29297289]),
     'radius': 0.01, 'h5_path': "{}/model_classes20_1rnn4_1_32_4.h5".format(MODELS_FOLDER), 'n_iterations': 10},
    {'idx_max': 9, 'other_idx': 2, 'in_tensor': np.array([10] * 40),
     'radius': 0.1, 'h5_path': "{}/model_classes20_1rnn2_0_64_4.h5".format(MODELS_FOLDER), 'n_iterations': 1000},
    {'idx_max': 13, 'other_idx': 0, 'in_tensor': np.array([1] * 40),
     'radius': 0.05, 'h5_path': "{}/model_classes20_1rnn2_1_32_4.h5".format(MODELS_FOLDER), 'n_iterations': 10},
    {'idx_max': 4, 'other_idx': 0, 'in_tensor': [10] * 40,
     'radius': 0, 'h5_path': "{}/model_classes5_1rnn2_0_64_4.h5".format(MODELS_FOLDER), 'n_iterations': 100},
    # {'idx_max': 1, 'other_idx': 0, 'in_tensor': np.array([0.19005403, 0.51136299, 0.67302099, 0.59573087, 0.78725824,
    #              0.47257432, 0.65504724, 0.69202802, 0.16531246, 0.84543712,
    #              0.73715671, 0.03674481, 0.39459927, 0.0107714, 0.15337461,
    #              0.44855902, 0.894079, 0.48551109, 0.08504609, 0.74320624,
    #              0.52363974, 0.80471539, 0.06424345, 0.65279486, 0.15554268,
    #              0.63541206, 0.15977761, 0.70137553, 0.34406331, 0.59930546,
    #              0.8740703, 0.89584981, 0.67799938, 0.78253788, 0.33091662,
    #              0.74464927, 0.69366703, 0.96878231, 0.58014617, 0.41094702]),
    #  'radius': 0, 'h5_path': "{}/model_classes20_1rnn8_0_64_100.h5".format(MODELS_FOLDER), 'n_iterations': 5},
    {'idx_max': 13, 'other_idx': 15,
     'in_tensor': np.array([6.3, 9.4, 9.6, 3.1, 8.5, 9.4, 7.2, 8.6, 3.8, 1.4, 0.7, 7.8, 1.9, 8.2, 6.2, 3.6, 8.7, 1.7
                               , 2.8, 4.8, 4.3, 5.1, 3.8, 0.8, 2.4, 7.6, 7.3, 0., 3.3, 7.4, 0., 2.1, 0.5, 8., 7.1, 3.9
                               , 3., 8.3, 5.6, 1.8]), 'radius': 0.01,
     'h5_path': "{}/model_classes20_1rnn4_0_2_4.h5".format(MODELS_FOLDER), 'n_iterations': 500},
    {'idx_max': 13, 'other_idx': 8, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 17, 'other_idx': 11, 'radius': 0,
     'in_tensor': np.array([0.20097051, 0.42479055, 0.34322315, 0.62437296, 0.25862801,
                            0.91247462, 0.63758399, 0.48962824, 0.31047408, 0.67587524,
                            0.49270075, 0.3388583, 0.10273122, 0.90489837, 0.55069923,
                            0.61848446, 0.7047673, 0.81861119, 0.20828558, 0.52244301,
                            0.66099873, 0.22497297, 0.04728098, 0.41952486, 0.30202405,
                            0.11102099, 0.08771732, 0.28779644, 0.58346806, 0.70012583,
                            0.53994143, 0.11465865, 0.26253562, 0.27067036, 0.61152968,
                            0.55825975, 0.59336236, 0.67116022, 0.05547967, 0.07961834]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_1_32_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 11, 'radius': 0,
     'in_tensor': np.array([0.5276819, 0.18475515, 0.84049484, 0.05101713, 0.65297865,
                            0.64000277, 0.68154397, 0.17374351, 0.30507248, 0.04626008,
                            0.7759239, 0.78172294, 0.50306415, 0.55160325, 0.5682504,
                            0.44300834, 0.57119383, 0.80649904, 0.61513483, 0.24398878,
                            0.06143529, 0.39079038, 0.44596474, 0.43369353, 0.29322568,
                            0.55481591, 0.99188989, 0.23542668, 0.38524337, 0.08206859,
                            0.49990265, 0.38417799, 0.28538922, 0.99828765, 0.37680467,
                            0.35437023, 0.30889233, 0.28867692, 0.77390004, 0.43394878]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 4, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 17, 'other_idx': 3, 'radius': 0,
     'in_tensor': np.array([0.20097051, 0.42479055, 0.34322315, 0.62437296, 0.25862801,
                            0.91247462, 0.63758399, 0.48962824, 0.31047408, 0.67587524,
                            0.49270075, 0.3388583, 0.10273122, 0.90489837, 0.55069923,
                            0.61848446, 0.7047673, 0.81861119, 0.20828558, 0.52244301,
                            0.66099873, 0.22497297, 0.04728098, 0.41952486, 0.30202405,
                            0.11102099, 0.08771732, 0.28779644, 0.58346806, 0.70012583,
                            0.53994143, 0.11465865, 0.26253562, 0.27067036, 0.61152968,
                            0.55825975, 0.59336236, 0.67116022, 0.05547967, 0.07961834]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_1_32_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 17, 'other_idx': 5, 'radius': 0,
     'in_tensor': np.array([0.20097051, 0.42479055, 0.34322315, 0.62437296, 0.25862801,
                            0.91247462, 0.63758399, 0.48962824, 0.31047408, 0.67587524,
                            0.49270075, 0.3388583, 0.10273122, 0.90489837, 0.55069923,
                            0.61848446, 0.7047673, 0.81861119, 0.20828558, 0.52244301,
                            0.66099873, 0.22497297, 0.04728098, 0.41952486, 0.30202405,
                            0.11102099, 0.08771732, 0.28779644, 0.58346806, 0.70012583,
                            0.53994143, 0.11465865, 0.26253562, 0.27067036, 0.61152968,
                            0.55825975, 0.59336236, 0.67116022, 0.05547967, 0.07961834]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_1_32_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 17, 'other_idx': 18, 'radius': 0,
     'in_tensor': np.array([0.20097051, 0.42479055, 0.34322315, 0.62437296, 0.25862801,
                            0.91247462, 0.63758399, 0.48962824, 0.31047408, 0.67587524,
                            0.49270075, 0.3388583, 0.10273122, 0.90489837, 0.55069923,
                            0.61848446, 0.7047673, 0.81861119, 0.20828558, 0.52244301,
                            0.66099873, 0.22497297, 0.04728098, 0.41952486, 0.30202405,
                            0.11102099, 0.08771732, 0.28779644, 0.58346806, 0.70012583,
                            0.53994143, 0.11465865, 0.26253562, 0.27067036, 0.61152968,
                            0.55825975, 0.59336236, 0.67116022, 0.05547967, 0.07961834]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_1_32_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 17, 'other_idx': 13, 'radius': 0,
     'in_tensor': np.array([0.20097051, 0.42479055, 0.34322315, 0.62437296, 0.25862801,
                            0.91247462, 0.63758399, 0.48962824, 0.31047408, 0.67587524,
                            0.49270075, 0.3388583, 0.10273122, 0.90489837, 0.55069923,
                            0.61848446, 0.7047673, 0.81861119, 0.20828558, 0.52244301,
                            0.66099873, 0.22497297, 0.04728098, 0.41952486, 0.30202405,
                            0.11102099, 0.08771732, 0.28779644, 0.58346806, 0.70012583,
                            0.53994143, 0.11465865, 0.26253562, 0.27067036, 0.61152968,
                            0.55825975, 0.59336236, 0.67116022, 0.05547967, 0.07961834]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_1_32_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 1, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 4, 'radius': 0,
     'in_tensor': np.array([0.5276819, 0.18475515, 0.84049484, 0.05101713, 0.65297865,
                            0.64000277, 0.68154397, 0.17374351, 0.30507248, 0.04626008,
                            0.7759239, 0.78172294, 0.50306415, 0.55160325, 0.5682504,
                            0.44300834, 0.57119383, 0.80649904, 0.61513483, 0.24398878,
                            0.06143529, 0.39079038, 0.44596474, 0.43369353, 0.29322568,
                            0.55481591, 0.99188989, 0.23542668, 0.38524337, 0.08206859,
                            0.49990265, 0.38417799, 0.28538922, 0.99828765, 0.37680467,
                            0.35437023, 0.30889233, 0.28867692, 0.77390004, 0.43394878]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 18, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 10, 'radius': 0,
     'in_tensor': np.array([0.5276819, 0.18475515, 0.84049484, 0.05101713, 0.65297865,
                            0.64000277, 0.68154397, 0.17374351, 0.30507248, 0.04626008,
                            0.7759239, 0.78172294, 0.50306415, 0.55160325, 0.5682504,
                            0.44300834, 0.57119383, 0.80649904, 0.61513483, 0.24398878,
                            0.06143529, 0.39079038, 0.44596474, 0.43369353, 0.29322568,
                            0.55481591, 0.99188989, 0.23542668, 0.38524337, 0.08206859,
                            0.49990265, 0.38417799, 0.28538922, 0.99828765, 0.37680467,
                            0.35437023, 0.30889233, 0.28867692, 0.77390004, 0.43394878]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 17, 'other_idx': 14, 'radius': 0,
     'in_tensor': np.array([0.20097051, 0.42479055, 0.34322315, 0.62437296, 0.25862801,
                            0.91247462, 0.63758399, 0.48962824, 0.31047408, 0.67587524,
                            0.49270075, 0.3388583, 0.10273122, 0.90489837, 0.55069923,
                            0.61848446, 0.7047673, 0.81861119, 0.20828558, 0.52244301,
                            0.66099873, 0.22497297, 0.04728098, 0.41952486, 0.30202405,
                            0.11102099, 0.08771732, 0.28779644, 0.58346806, 0.70012583,
                            0.53994143, 0.11465865, 0.26253562, 0.27067036, 0.61152968,
                            0.55825975, 0.59336236, 0.67116022, 0.05547967, 0.07961834]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_1_32_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 17, 'other_idx': 4, 'radius': 0,
     'in_tensor': np.array([0.20097051, 0.42479055, 0.34322315, 0.62437296, 0.25862801,
                            0.91247462, 0.63758399, 0.48962824, 0.31047408, 0.67587524,
                            0.49270075, 0.3388583, 0.10273122, 0.90489837, 0.55069923,
                            0.61848446, 0.7047673, 0.81861119, 0.20828558, 0.52244301,
                            0.66099873, 0.22497297, 0.04728098, 0.41952486, 0.30202405,
                            0.11102099, 0.08771732, 0.28779644, 0.58346806, 0.70012583,
                            0.53994143, 0.11465865, 0.26253562, 0.27067036, 0.61152968,
                            0.55825975, 0.59336236, 0.67116022, 0.05547967, 0.07961834]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_1_32_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 0, 'radius': 0,
     'in_tensor': np.array([0.5276819, 0.18475515, 0.84049484, 0.05101713, 0.65297865,
                            0.64000277, 0.68154397, 0.17374351, 0.30507248, 0.04626008,
                            0.7759239, 0.78172294, 0.50306415, 0.55160325, 0.5682504,
                            0.44300834, 0.57119383, 0.80649904, 0.61513483, 0.24398878,
                            0.06143529, 0.39079038, 0.44596474, 0.43369353, 0.29322568,
                            0.55481591, 0.99188989, 0.23542668, 0.38524337, 0.08206859,
                            0.49990265, 0.38417799, 0.28538922, 0.99828765, 0.37680467,
                            0.35437023, 0.30889233, 0.28867692, 0.77390004, 0.43394878]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 14, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 3, 'radius': 0,
     'in_tensor': np.array([0.5276819, 0.18475515, 0.84049484, 0.05101713, 0.65297865,
                            0.64000277, 0.68154397, 0.17374351, 0.30507248, 0.04626008,
                            0.7759239, 0.78172294, 0.50306415, 0.55160325, 0.5682504,
                            0.44300834, 0.57119383, 0.80649904, 0.61513483, 0.24398878,
                            0.06143529, 0.39079038, 0.44596474, 0.43369353, 0.29322568,
                            0.55481591, 0.99188989, 0.23542668, 0.38524337, 0.08206859,
                            0.49990265, 0.38417799, 0.28538922, 0.99828765, 0.37680467,
                            0.35437023, 0.30889233, 0.28867692, 0.77390004, 0.43394878]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 17, 'other_idx': 0, 'radius': 0,
     'in_tensor': np.array([0.20097051, 0.42479055, 0.34322315, 0.62437296, 0.25862801,
                            0.91247462, 0.63758399, 0.48962824, 0.31047408, 0.67587524,
                            0.49270075, 0.3388583, 0.10273122, 0.90489837, 0.55069923,
                            0.61848446, 0.7047673, 0.81861119, 0.20828558, 0.52244301,
                            0.66099873, 0.22497297, 0.04728098, 0.41952486, 0.30202405,
                            0.11102099, 0.08771732, 0.28779644, 0.58346806, 0.70012583,
                            0.53994143, 0.11465865, 0.26253562, 0.27067036, 0.61152968,
                            0.55825975, 0.59336236, 0.67116022, 0.05547967, 0.07961834]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_1_32_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 12, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 15, 'radius': 0,
     'in_tensor': np.array([0.5276819, 0.18475515, 0.84049484, 0.05101713, 0.65297865,
                            0.64000277, 0.68154397, 0.17374351, 0.30507248, 0.04626008,
                            0.7759239, 0.78172294, 0.50306415, 0.55160325, 0.5682504,
                            0.44300834, 0.57119383, 0.80649904, 0.61513483, 0.24398878,
                            0.06143529, 0.39079038, 0.44596474, 0.43369353, 0.29322568,
                            0.55481591, 0.99188989, 0.23542668, 0.38524337, 0.08206859,
                            0.49990265, 0.38417799, 0.28538922, 0.99828765, 0.37680467,
                            0.35437023, 0.30889233, 0.28867692, 0.77390004, 0.43394878]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 17, 'other_idx': 7, 'radius': 0,
     'in_tensor': np.array([0.20097051, 0.42479055, 0.34322315, 0.62437296, 0.25862801,
                            0.91247462, 0.63758399, 0.48962824, 0.31047408, 0.67587524,
                            0.49270075, 0.3388583, 0.10273122, 0.90489837, 0.55069923,
                            0.61848446, 0.7047673, 0.81861119, 0.20828558, 0.52244301,
                            0.66099873, 0.22497297, 0.04728098, 0.41952486, 0.30202405,
                            0.11102099, 0.08771732, 0.28779644, 0.58346806, 0.70012583,
                            0.53994143, 0.11465865, 0.26253562, 0.27067036, 0.61152968,
                            0.55825975, 0.59336236, 0.67116022, 0.05547967, 0.07961834]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_1_32_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 5, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 10, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 7, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 11, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 3, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 6, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 17, 'other_idx': 8, 'radius': 0,
     'in_tensor': np.array([0.20097051, 0.42479055, 0.34322315, 0.62437296, 0.25862801,
                            0.91247462, 0.63758399, 0.48962824, 0.31047408, 0.67587524,
                            0.49270075, 0.3388583, 0.10273122, 0.90489837, 0.55069923,
                            0.61848446, 0.7047673, 0.81861119, 0.20828558, 0.52244301,
                            0.66099873, 0.22497297, 0.04728098, 0.41952486, 0.30202405,
                            0.11102099, 0.08771732, 0.28779644, 0.58346806, 0.70012583,
                            0.53994143, 0.11465865, 0.26253562, 0.27067036, 0.61152968,
                            0.55825975, 0.59336236, 0.67116022, 0.05547967, 0.07961834]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_1_32_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 17, 'other_idx': 10, 'radius': 0,
     'in_tensor': np.array([0.20097051, 0.42479055, 0.34322315, 0.62437296, 0.25862801,
                            0.91247462, 0.63758399, 0.48962824, 0.31047408, 0.67587524,
                            0.49270075, 0.3388583, 0.10273122, 0.90489837, 0.55069923,
                            0.61848446, 0.7047673, 0.81861119, 0.20828558, 0.52244301,
                            0.66099873, 0.22497297, 0.04728098, 0.41952486, 0.30202405,
                            0.11102099, 0.08771732, 0.28779644, 0.58346806, 0.70012583,
                            0.53994143, 0.11465865, 0.26253562, 0.27067036, 0.61152968,
                            0.55825975, 0.59336236, 0.67116022, 0.05547967, 0.07961834]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_1_32_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 15, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 16, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 13, 'other_idx': 0, 'radius': 0,
     'in_tensor': np.array([0.23568325, 0.70237988, 0.3166374, 0.74627353, 0.22739224,
                            0.95291164, 0.24576, 0.40445054, 0.36892157, 0.08092092,
                            0.57902572, 0.82626711, 0.56028983, 0.44413096, 0.81031513,
                            0.16866558, 0.93686892, 0.06449081, 0.23722131, 0.74648442,
                            0.85571668, 0.38552926, 0.99267338, 0.32447941, 0.14312457,
                            0.09192649, 0.94586319, 0.47928956, 0.23663665, 0.17057757,
                            0.86041277, 0.08677493, 0.38599816, 0.95202792, 0.25024289,
                            0.44774631, 0.21569389, 0.56249737, 0.24707225, 0.86096177]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_0_2_4.h5'.format(MODELS_FOLDER)},
    {'idx_max': 17, 'other_idx': 1, 'radius': 0,
     'in_tensor': np.array([0.20097051, 0.42479055, 0.34322315, 0.62437296, 0.25862801,
                            0.91247462, 0.63758399, 0.48962824, 0.31047408, 0.67587524,
                            0.49270075, 0.3388583, 0.10273122, 0.90489837, 0.55069923,
                            0.61848446, 0.7047673, 0.81861119, 0.20828558, 0.52244301,
                            0.66099873, 0.22497297, 0.04728098, 0.41952486, 0.30202405,
                            0.11102099, 0.08771732, 0.28779644, 0.58346806, 0.70012583,
                            0.53994143, 0.11465865, 0.26253562, 0.27067036, 0.61152968,
                            0.55825975, 0.59336236, 0.67116022, 0.05547967, 0.07961834]), 'n_iterations': 5,
     'h5_path': '{}/model_classes20_1rnn4_1_32_4.h5'.format(MODELS_FOLDER)},
]

# def classes20_1rnn4_1fc32():
#     n_inputs = 40
#     y_idx_max = 9
#     other_idx = 14
#     in_tensor = np.array([0.43679032, 0.51105192, 0.01603254, 0.45879329, 0.64639347,
#                           0.39209051, 0.98618169, 0.49293316, 0.70440262, 0.08594672,
#                           0.17252591, 0.4940284, 0.83947774, 0.55545332, 0.8971317,
#                           0.72996308, 0.23706766, 0.66869303, 0.74949942, 0.57524252,
#                           0.94886307, 0.31034989, 0.41785656, 0.5697128, 0.74751913,
#                           0.48868271, 0.22672374, 0.6350584, 0.88979192, 0.97493685,
#                           0.96969836, 0.99457045, 0.89433312, 0.19916606, 0.63957592,
#                           0.02826659, 0.08104817, 0.20176526, 0.1114994, 0.29297289])
#     assert in_tensor.shape[0] == n_inputs
#     return run_one_comperasion(in_tensor, 0.01, y_idx_max, other_idx,
#                                "{}/model_classes20_1rnn4_1_32_4.h5".format(MODELS_FOLDER), n_iterations=10)
#
#
# def classes20_1rnn2_1fc32():
#     n_inputs = 40
#     y_idx_max = 13
#     other_idx = 0
#     return run_one_comperasion([1] * n_inputs, 0.05, y_idx_max, other_idx,
#                                "/home/yuval/projects/Marabou/model_classes20_1rnn2_1_32_4.h5", 10)


if __name__ == "__main__":
    all_results = []
    # exp = experiemnts[3]
    # alg = IterateAlphasSGD
    # res = adversarial_query(exp['in_tensor'], exp['radius'], exp['idx_max'], exp['other_idx'], exp['h5_path'], alg,
    #                                   exp['n_iterations'])
    # exit(0)

    exp = {'idx_max': 9, 'other_idx': 2, 'in_tensor': np.array([10] * 40),
     'radius': 0.01, 'h5_path': "{}/model_classes20_1rnn2_0_64_4_no_bias.h5".format(MODELS_FOLDER),
     'n_iterations': 4}
    exp = {'idx_max': 4, 'other_idx': 0, 'in_tensor': [10] * 40,
     'radius': 0, 'h5_path': "{}/model_classes5_1rnn2_0_64_4.h5".format(MODELS_FOLDER), 'n_iterations': 100}
    assert adversarial_query(exp['in_tensor'], exp['radius'], exp['idx_max'], exp['other_idx'], exp['h5_path'],
                             IterateAlphasSGD, exp['n_iterations'])
    assert not adversarial_query(exp['in_tensor'], exp['radius'], exp['other_idx'], exp['idx_max'], exp['h5_path'],
                                 IterateAlphasSGD, exp['n_iterations'])
    exit(0)
    for exp in experiemnts:
        exp_res = run_one_comparison(exp['in_tensor'], exp['radius'], exp['idx_max'], exp['other_idx'], exp['h5_path'],
                                     exp['n_iterations'])
        exp_name = exp['h5_path'].split('.')[0].split('/')[-1] + '_' + str(exp['n_iterations'])
        all_results.append((exp_name, exp_res))
        print("Finish Test: {}, results: {}".format(exp_name, exp_res))

    for result in all_results:
        print("Finish Test: {}, results: {}".format(result[0], result[1]))
    import pickle

    pickle.dump(all_results, open("all_results.pkl", "wb"))
